cmake_minimum_required(VERSION 2.6)
project(fivehundred)

# Grab required libraries
find_package(Qt4 COMPONENTS QtCore QtGui REQUIRED)
find_package(Lua51 REQUIRED)

# Generate C++ from Qt objects
qt4_wrap_cpp(MOCS card.hpp game.hpp biddialog.hpp contract.hpp human.hpp mainwindow.hpp player.hpp scorechart.hpp newgamedialog.hpp setupplayer.hpp)
qt4_wrap_ui(UI_OUTPUT biddialog.ui mainwindow.ui scorechart.ui newgamedialog.ui setupplayer.ui)

# Include Qt dirs and current binary dir (location of autogenerated c++)
include_directories(${QT_INCLUDES} ${CMAKE_CURRENT_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR} ${LUA_INCLUDE_DIR})

# Define the executable
add_definitions(--std=c++0x -Wall -Wextra -Werror)
add_executable(fivehundred
		${UI_OUTPUT}
		${MOCS}
		bid.cpp
		biddialog.cpp
		bidding.cpp
		card.cpp
		computer.cpp
		contract.cpp
		deck.cpp
		game.cpp
		human.cpp
		log.cpp
		main.cpp
		mainwindow.cpp
		newgamedialog.cpp
		os.cpp
		player.cpp
		scorechart.cpp
		setupplayer.cpp
		suit.cpp
		trick.cpp
		)
		
target_link_libraries(
	fivehundred
	${QT_QTCORE_LIBRARY}
	${QT_QTGUI_LIBRARY}
	${LUA_LIBRARIES}
)

install(TARGETS fivehundred RUNTIME DESTINATION bin)
install(DIRECTORY gfx DESTINATION share/fivehundred PATTERN ".svn" EXCLUDE)
install(DIRECTORY scripts DESTINATION share/fivehundred PATTERN ".svn" EXCLUDE)

set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "Five Hundred is a card game")

set(CPACK_PACKAGE_VENDOR "Oliver Giles")
set(CPACK_PACKAGE_DESCRIPTION_FILE "${CMAKE_CURRENT_SOURCE_DIR}/README")
set(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_CURRENT_SOURCE_DIR}/COPYING")

set(CPACK_PACKAGE_VERSION_MAJOR "0")
set(CPACK_PACKAGE_VERSION_MINOR "1")
find_package(Subversion REQUIRED)
Subversion_WC_INFO(${CMAKE_CURRENT_SOURCE_DIR} SVN)
set(CPACK_PACKAGE_VERSION_PATCH "0alpha~r${SVN_WC_REVISION}")
set(CPACK_PACKAGE_VERSION ${CPACK_PACKAGE_VERSION_MAJOR}.${CPACK_PACKAGE_VERSION_MINOR}.${CPACK_PACKAGE_VERSION_PATCH})

file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/version.h.txt" "#define VERSION \"${CPACK_PACKAGE_VERSION}\"")

add_custom_target(version.h COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_CURRENT_BINARY_DIR}/version.h.txt version.h)

add_dependencies(fivehundred version.h)
#set(CPACK_PACKAGE_INSTALL_DIRECTORY "CMake ${CMake_VERSION_MAJOR}.${CMake_VERSION_MINOR}")

if(WIN32 AND NOT UNIX)
    # There is a bug in NSI that does not handle full unix paths properly. Make
    # sure there is at least one set of four (4) backlasshes.
    set(CPACK_PACKAGE_ICON "${CMAKE_CURRENT_SOURCE_DIR}/gfx\\\\icon48.png")
    set(CPACK_NSIS_INSTALLED_ICON_NAME "bin\\\\MyExecutable.exe")
    set(CPACK_NSIS_DISPLAY_NAME "${CPACK_PACKAGE_INSTALL_DIRECTORY} Five Hundred")
    #set(CPACK_NSIS_HELP_LINK "http:\\\\\\\\www.my-project-home-page.org")
    #set(CPACK_NSIS_URL_INFO_ABOUT "http:\\\\\\\\www.my-personal-home-page.com")
    #set(CPACK_NSIS_CONTACT "me@my-personal-home-page.com")
    set(CPACK_NSIS_MODIFY_PATH ON)
	set(CPACK_GENERATOR "NSIS")
else()
	configure_file(fivehundred.desktop.in fivehundred.desktop)
	install(FILES ${CMAKE_CURRENT_BINARY_DIR}/fivehundred.desktop DESTINATION share/applications)

	if(CMAKE_SIZEOF_VOID_P EQUAL 8)
		set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "amd64")
		set(CPACK_SYSTEM_NAME "amd64")
	else()
		set(CPACK_DEBIAN_PACKAGE_ARCHITECTURE "i386")
		set(CPACK_SYSTEM_NAME "i386")
	endif()
    add_dependencies(fivehundred installprefix.h)
    set(CPACK_DEBIAN_PACKAGE_NAME "fivehundred")
    set(CPACK_DEBIAN_PACKAGE_DEPENDS "libstdc++6 (>= 4.5), libqt4-core (>= 4.5), liblua5.1-0-dev")
    set(CPACK_DEBIAN_PACKAGE_MAINTAINER "Oliver Giles")
	set(CPACK_DEBIAN_PACKAGE_DESCRIPTION "Five Hundred is a card game for four players similar to Euchre or Bridge. This cross-platform Qt-based implementation includes both a graphical mode and a non-interactive mode and Lua scripting engine to develop AI players")
    set(CPACK_GENERATOR "DEB;TGZ")
endif()
include(CPack)


# Add tests
enable_testing()
add_subdirectory(test)
